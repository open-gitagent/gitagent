import { existsSync, readFileSync, readdirSync } from 'node:fs';
import { join, resolve } from 'node:path';
import yaml from 'js-yaml';
import { loadAgentManifest, loadFileIfExists } from '../utils/loader.js';
import { loadAllSkills } from '../utils/skill-loader.js';

export function exportToCrewAI(dir: string): string {
  const agentDir = resolve(dir);
  const manifest = loadAgentManifest(agentDir);

  const soul = loadFileIfExists(join(agentDir, 'SOUL.md'));

  // Parse SOUL.md for role, goal, backstory
  let role = manifest.description;
  let goal = manifest.description;
  let backstory = '';

  if (soul) {
    const sections = parseSoulSections(soul);
    if (sections['Core Identity']) role = sections['Core Identity'];
    if (sections['Values & Principles']) goal = sections['Values & Principles'];
    backstory = soul.replace(/^#.*$/gm, '').trim();
  }

  // Add skill descriptions as capabilities
  const skillsDir = join(agentDir, 'skills');
  const skills = loadAllSkills(skillsDir);
  if (skills.length > 0) {
    const skillDescriptions = skills
      .map(s => `- ${s.frontmatter.name}: ${s.frontmatter.description}`)
      .join('\n');
    backstory += `\n\nCapabilities (Skills):\n${skillDescriptions}`;
  }

  // Build CrewAI YAML config
  const crewConfig: Record<string, unknown> = {
    agents: {
      [manifest.name]: {
        role: role.slice(0, 500),
        goal: goal.slice(0, 500),
        backstory: backstory.slice(0, 2000),
        verbose: true,
        allow_delegation: manifest.delegation?.mode === 'auto',
      },
    },
  };

  // Add sub-agents
  if (manifest.agents) {
    for (const [name, config] of Object.entries(manifest.agents)) {
      const subAgentDir = join(agentDir, 'agents', name);
      const subSoul = loadFileIfExists(join(subAgentDir, 'SOUL.md'));

      (crewConfig.agents as Record<string, unknown>)[name] = {
        role: config.description ?? name,
        goal: config.description ?? name,
        backstory: subSoul?.replace(/^#.*$/gm, '').trim().slice(0, 2000) ?? '',
        verbose: true,
      };
    }
  }

  return `# CrewAI configuration generated by gitagent export\n# Source: ${manifest.name} v${manifest.version}\n\n${yaml.dump(crewConfig, { lineWidth: 120 })}`;
}

function parseSoulSections(markdown: string): Record<string, string> {
  const sections: Record<string, string> = {};
  const lines = markdown.split('\n');
  let currentTitle = '';
  let currentContent = '';

  for (const line of lines) {
    const headingMatch = line.match(/^#{1,3}\s+(.+)/);
    if (headingMatch) {
      if (currentTitle) {
        sections[currentTitle] = currentContent.trim();
      }
      currentTitle = headingMatch[1];
      currentContent = '';
    } else {
      currentContent += line + '\n';
    }
  }

  if (currentTitle) {
    sections[currentTitle] = currentContent.trim();
  }

  return sections;
}
